M.Brown and D.G.Lowe
{mbrown|lowe}@cs.ubc.ca
Department of Computer Science,
University of British Columbia,
Vancouver, Canada.

Recognising Panoramas
全景图的识别

摘要
目的: 全自动构建全景图
方法: 用基于不变的局部特征的物体识别技术来选择匹配图像，用概率模型来验证。
优点: 对图像的顺序，方向，比例和明度不敏感；对根本不属于全景图的“杂讯”也不敏感。
结果: 系统将整个闪存卡或胶片上的图像作为输入，识别出可以属于全景图部分的图像，在没     有任何用户输入的情况下将它们拼接起来

1. 介绍
	在商业应用中，估计过程通常需要以用户输入的形式或是固定顺序的图像。
	在自动图像匹配/几何估计的研究方法中，有两个阵营：直接方法和基于特征方法。
	基于特征方法开始于建立点、线和其他几何实体间的对应关系。例如，一个典型的方法是提取Harris corners并使用局部强度值的归一化互相关来匹配它们。
	直接方法试图通过基于重叠区域中的强度差最小化误差函数来迭代地估计相机参数。直接方法的优势在于使用了所有可使用的数据因此可以提供十分准确的匹配；但是其基于脆弱的“亮度恒定”的假设，而且迭代需要初始化。
	但是（假设使用常规特性），上述方法对于图片缩放、亮度变化和“杂讯”图片来说都不够健壮。
	最近在将不变特性用于物体识别和匹配上有了很大的进展。与传统方法（如使用哈里斯角的互相关）相比，这些特性可以更加可重复地找到并且更加可靠地匹配。哈里斯角对于图片的缩放来说不是不变的，图像块的互相关对于旋转来说不是不变的。但是不变特性的目的就是要对这些变换保持不变。在这项工作中我们使用Lowe的尺度不变特征变换（SIFT特性），其在相似变换下是几何不变的，并且在强度的仿射变化下是不变的。
	尽管匹配n张图像可能看起来具有二次复杂性，但它可以减少到O(nlogn)。这是通过使用近似最近邻居算法来匹配特征来完成的。Schaffalitzky和Zisserman在运动结构的背景下采取了类似的方法。我们的工作与此不同，我们使用全景图像几何。另外，我们引入了用于图像匹配验证的概率模型。这为我们拒绝噪声图像和在无序图像集中识别多个全景图提供了一个有原则的框架。
	在相机参数上进行优化以最小化匹配误差的过程称为光束平差法。我们将所有匹配特征的鲁棒后的误差平方和用作目标函数。这产生了一个非线性最小二乘问题，我们使用Levenberg-Marquadt算法解决。为了无缝融合全景，我们使用了Burt和Adelson提出的多波段混合策略。这样可以在整体强度不同的图像之间平滑过渡，即使存在少量误匹配也能保留清晰的细节。
2. 特征匹配
	全景识别算法的第一步是提取和匹配所有图像中的SIFT特征。SIFT特征位于高斯函数差异的尺度空间的最大值/最小值。在每个特征位置建立特征尺度和方向。这给出了测量相似性不变的框架。尽管在这个框架中简单地对强度值采样将是相似性不变的，不变描述符实际上通过累加方向直方图中的局部梯度来计算。这允许边稍微移动而不改变描述符向量，给仿射变换提供了一些鲁棒性。这个梯度向量是经过归一化的，并且因为其由强度值的差组成，所以它对强度的仿射变换是不变的。
	假设相机围绕其光学中心旋转，图像的可能经历的一组变换是一组特殊的单应性变换。我们用3个旋转角度θ=[θ1 θ2 θ3]和焦距f来对每个相机进行参数化。这提供了成对的单应性ui = Hijuj

是一个通过线性化ui0单应性而获得的仿射变换。这意味着每个小图像块都经历了仿射变换，并证明了在仿射变化下部分不变的SIFT特征的使用。
	一旦特征从所有n个图像（线性时间）提取出来，它们必须被匹配。因为多个图像可能在一条射线上重叠，因此每个特征都与它的k个最近邻居匹配（我们使用k = 4）。这可以在O（nlogn）时间通过使用k-d树来找到近似最近的邻居来完成。

3. 图像匹配
	在这个阶段我们的目标是找出所有匹配（例如：重叠）的图像。被连接的匹配图像的集合之后会变成全景图。因为每张图像潜在地可能与其他所有的图像匹配，所以这个问题一开始看起来是一个图像数量的二次问题。但是，为了为图像几何体获得较好的解决方案，只需要将每幅图像与少量相邻图像进行匹配。
	从特征匹配阶段，我们已经找出彼此间有大量匹配的图像。我们考虑一个常数m个图像，它们与当前图像具有最多的特征匹配，作为潜在的图像匹配（我们使用m = 6）。首先，我们使用RANSAC来选择一组与图像之间的单应性兼容的内点。接下来我们应用概率模型来验证匹配。
3.1 用于验证图像匹配的概率模型
	对每一对潜在的匹配图像我们都有一组几何一致的特征匹配（RANSAC内点）和一组在重叠区域内但不一致的特征（RANSAC离群点）。我们验证模型的思路是比照这一组内点/外点是由正确的图像匹配或由错误的图像匹配产生的概率。
	对于一张给定的图像我们表示在重叠区域nf的特征总数和内点ni的数量。图像是否正确匹配的事件由二进制变量m0,1表示。第i个特征匹配f(i)0,1是一个内点/离群点的事件假定是独立伯努利变量，所以内点的总数是二项分布

这里p1是给定正确图像匹配，特征是内部特征的概率；p0是是给定错误图像匹配，特征是内部特征的概率。内点的数量ni=i=1nff(i)。我们选择值p1=0.7，p0=0.01。现在我们可以用贝叶斯定理估计一张图片匹配是正确的后验概率：

如果，我们就接受一张图片。假设一个统一的先验，这个将问题简化成一个似然比检测：

选择值pmin = 0.97 时当满足如下条件时：

那么是一个正确的图像匹配。
一旦在图像之间建立了成对匹配，我们可以找到全景序列作为匹配图像的连接集合。这使我们能够识别一组图像中的多个全景图，并拒绝与其他图像都不匹配的噪声图像（参见图（2））

4. 光束法平差
	
给定一组图像之间的几何一致匹配，我们使用光束法平差来共同解决所有相机参数。这是必不可少的步骤，因为成对的单应性级联会引起累积错误并忽略图像之间的多重约束，例如，全景的尽头应该结合起来。图像将逐个添加到束调整器中，并在每个步骤中添加最匹配的图像（最大匹配数）。新图像以与其最匹配的图像相同的旋转和焦距进行初始化。然后使用Levenberg-Marquardt更新参数。
我们使用的目标函数是一个鲁棒过后的投影误差平方和。也就是说，每个特征被投影到所有它匹配的图像上去，然后影像距离的平方和相对于相机的参数被最小化。
给定一组对照（表示图像i中第k个特征的位置），剩余是这里是对应到的点从图像j到图像i的投影。
误差函数是所有图像鲁棒后的剩余误差的和
在这里n是图像的数量，是与图像i匹配的图像集合，是图像i和图像j之间匹配特征的集合，是一个鲁棒误差函数
在初始化我成我们令，在最终解时令xmax = 1 pixel。这是一个非线性最小二乘问题，我们使用Levenberg-Marquardt算法解决。每个迭代步骤都是以如下这种形式：

这里是所有参数，r是剩余，J = 。我们编码我们之前对协方差矩阵Cp中参数变化的想法。这里被设置成角度的标准差是，焦距是。这有助于选择合适的步长，从而加速收敛。例如，如果使用球面协方差矩阵，则旋转1弧度的变化将被等效为焦距中1个像素的变化。最后，σ表示投影误差的标准差，并且通过Levenberg-Marquardt变化以确保目标函数在每次迭代中实际上减少。
导数通过链式法则分析计算，例如：

在这里：

然后：


5. 多分辨率融合
	理想情况下，每个样本（像素）沿射线在相交的每个图像中都具有相同的强度，但事实上情况并非如此。造成这种情况的原因有很多：光圈/曝光时间的变化，渐晕（强度朝向图像的边缘减小），由于不希望发生的光学中心的移动引起的视差效应，以及由于相机错误模拟造成的错误配准误差，径向失真等。因此，良好的混合策略非常重要。
	为了组合来自多个图像的信息我们给每个图像分配一个权重w(x, y) = w(x)w(y)，这里w(x)从中心的1到边界的0线性变化。一种简单的混合方法是使用这些权重函数来运算沿每条射线的图像强度的加权和。但是，如果存在小的匹配误差，这种方法会导致高频细节的模糊。为了防止这种情况，我们应用了Burt和Adelson开发的多分辨率融合策略。多分辨率融合背后的想法是在较大的空间范围内混合低频，并在小范围内混合高频。这种方法可以使用拉普拉斯金字塔在多个频段上执行。	
在我们的实施中，我们使用了简单的2波段方案。使用波长相对于渲染图像大于2个像素的空间频率形成低通图像，低于2个像素的空间频率形成高通图像。然后，我们使用线性加权和来融合低频信息，并从最大权重的图像中选择高频信息。
尽管在融合方案中使用更多的频带将是合乎需要的，但是一个公开的问题是为任意重叠的图像设计合适的样条函数。

6. 结果
	图（2）显示了全景识别算法的典型操作。输入是一组包含2个全景图和5个噪声图像的图像。该算法检测到图像匹配的2个连接组成部分和5个不匹配的图像，并输出2个混合全景图。完整的算法在2GHz PC上运行83秒，输入图像为525×375像素（以75 dpi扫描7’’×5’’尺寸的照片），并将较大输出全景图渲染为300×3000像素图像。大部分计算时间用于从图像中提取SIFT特征
图（3）显示了一个更大的例子，其中80个图像用于创建360°×90°全景。不需要用户输入：对象识别系统决定哪些图像匹配，并且光束法平差算法针对所有相机的4×80 = 320参数共同优化。最后，尽管照度变化（相机闪光灯和光圈/曝光变化），但多波段混合方案仍能有效隐藏接缝。我们已经在许多其他图像集上测试了该系统，例如完整的360°×180°全景图以及在同一全景图中使用不同相机。更多的例子可以在http://www.cs.ubc.ca/~mbrown/panorama/panorama.html 找到


算法：全景图识别
输入：n张无序图像
Ⅰ. 从所有n张图像中提取SIFT特征
Ⅱ. 对每个特征用一个k-d树找出其k个最近的邻居
Ⅲ. 对每张图像：
    （1）选择m个候选的匹配图像（使用与这张图像特征匹配数量最多的图像）
    （2）使用RANSAC找出集合一致性的特征匹配来解出匹配图像对之间的单应性
    （3）使用概率模型来验证图像匹配
Ⅳ. 找出匹配图像的连接内容
Ⅴ. 对每个连接内容：
    （1）执行光束法平差来解出所有相机的旋转角度和焦距f
    （2）使用多频融合来渲染全景图
输出：全景图


7. 结论
	本文提出了一种新的全自动全景拼接系统。我们使用不变的局部特征和概率模型来验证图像匹配，使我们能够识别无序图像集中的多个全景图，并在没有用户输入的情况下自动完成拼接。该系统对于相机变焦，输入图像的方向以及由于闪光和曝光/光圈设置而引起的照明变化都很稳健。多波段混合方案可确保图像之间的平滑过渡，同时保留高频细节。未来可能的方向是尝试区分3D图像（相机转换）和全景图（相机固定），并在混合方案中使用更多的频带。

